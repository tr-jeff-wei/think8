<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>生字練習</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
      
    <!-- Custom styles for this template -->
    <link href="css/clean-blog.min.css" rel="stylesheet">
    <link href="css/notosanstc.css" rel="stylesheet">

      <style>
      
          .site-heading > h1{
              font-family: 'Noto Sans TC', sans-serif;
              font-weight: 500 ;
          }
          .post-subtitle{
              font-family: 'Noto Sans TC', sans-serif;
          }
          .file-input{
              font-family: 'Noto Sans TC', sans-serif;
              font-size: 16px;
              color:aliceblue;
          }
          .btn{
              font-weight: 500;
              padding: 7px 7px;               
          }
      
      </style>
      
  </head>

  <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
      <div class="container">
        <div class="navbar-brand" id="stopwatch"></div>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          Menu
          <i class="fa fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
              <li class="nav-item">
              <a class="nav-link" href="#" onclick="get_items();">Save</a>
            </li>            
            <li class="nav-item">
              <input type="file" class="file-input" id="loadfile">
            </li>
            
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Header -->
    <header class="masthead" style="background-image: url('img/home-bg.jpg')">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <div class="site-heading">
              <h3>生字演練區</h3>
              <span class="subheading">Practice More, Gain More</span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="container">        
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto" id="list">
          
            
        </div>            
      </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <ul class="list-inline text-center">
              <li class="list-inline-item">
                <a href="#">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="#">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="#">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
            </ul>
            <p class="copyright text-muted">Copyright &copy; Your Website 2017</p>              
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/popper/popper.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Custom scripts for this template -->
    <script src="js/clean-blog.min.js"></script>
  
    <script>
        
        var sentences = [] ;
        var sentences_n = [] ;
        var file_name = "" ;

        var seconds = 0, minutes = 0, hours = 0;
        var timer = document.getElementById('stopwatch') ;

        function add_timer() {
            seconds++;
            if (seconds >= 60) {
                seconds = 0;
                minutes++;
                if (minutes >= 60) {
                    minutes = 0;
                    hours++;
                }
            }

            timer.textContent = (hours ? (hours > 9 ? hours : "0" + hours) : "00") + ":" + (minutes ? (minutes > 9 ? minutes : "0" + minutes) : "00") + ":" + (seconds > 9 ? seconds : "0" + seconds);
            setTimeout(add_timer, 1000);
        }
        
           

        function sort_sentences( target_list , target_list_n ){
          //target_list = ['E','B','D','C','A'] ;
          //target_list_n = [  4, 1 , 3 , 2 ,0] ;

            var new_list = [] ;
            var new_list_n = [] ;
            
            while(target_list.length>0){
              var min_n = 10000 ;
              var min_idx = -1 ;
            
              for (var i = target_list_n.length - 1; i >= 0; i--) {
                  if( target_list_n[i] <= min_n ){
                      min_n = target_list_n[i] ;
                      min_idx = i ;
                  }              
              }
              new_list.push( target_list.splice(min_idx,1)[0] ) ;
              new_list_n.push( target_list_n.splice(min_idx,1)[0] ) ;
            }
          
            return [new_list , new_list_n] ;
        }

        
        function list_items(){
            
            var list = document.getElementById("list") ;
            
            list.innerHTML = "" ;

            
            var content ;
            for( var i=0 ;  i<sentences.length ; i++){
                
                content = 
                    
              "<div class='post-preview'>"+
                "<a href='http://fcjonline.com/index.php/tc/dictionary/word?q="+sentences[i]+"' target='_blank'> "+
                "<h3 class='post-subtitle'>"+sentences[i]+"</h3></a>"+                                     
                "<span class='badge badge-secondary'>"+sentences_n[i]+"</span>&nbsp;&nbsp;"+ 
                "<button class='btn btn-primary' onclick='check_item(this);'>CHECK</button>&nbsp;&nbsp;"+ 
                "<button class='btn btn-danger' onclick='add_practice_items(this);'>＋</button>"+             
              "</div><hr>";
                
                $(list).append($(content));
            }
            
        }
        
        function check_item( reference ){
            var p = reference.parentElement ;
            var its = p.getElementsByTagName("div") ;
            var count = 0 ;
            while(its.length>0){                
                its[0].remove() ;
                count++ ;
            }
            var number = p.getElementsByTagName("span")[0] ;
            number.textContent = parseInt( number.textContent ) +count ;
        }
    
        function add_practice_items( reference ){
            
            
            
            for( var i=5 ; i>0 ; i-- ){
                var txt = 
                "<div class='input-group'><span style='width: 40px;' class='input-group-addon'>"+i
                +"</span><input type='text' class='form-control'></div>" ;
                $(reference).after($(txt));    
            }
            $(reference).after($("<br><br>"));    
            
            
            //alert("clock");
        }
        
        function get_items(){
            
            console.log( "start loading items ... ");
            console.log( " -------------------------- ") ;
            
            var final_datas = [] ;
            
            var items = document.getElementsByClassName('post-preview') ;
            for( var i=0 ; i<items.length ; i++){
                var title = items[i].getElementsByTagName('h3')[0].textContent.trim() ;
                var n =  items[i].getElementsByTagName('span')[0].textContent.trim() ;
                
                console.log( title+"  -->  "+ n) ;
                final_datas.push([n,title]) ;
            }
            console.log( " -------------------------- ") ;
            var d = new Date()
            var day = (d.getMonth()+1)+""+d.getDate()+"-"+d.getHours()+d.getMinutes() ;
            exportToCsv(file_name+day+".txt" ,final_datas) ;
            console.log( "export items ... finished!!");
            
        }
               
        
        function exportToCsv(filename, rows) {
            var processRow = function (row) {
                var finalVal = '';
                for (var j = 0; j < row.length; j++) {
                    var innerValue = row[j] === null ? '' : row[j].toString();
                    if (row[j] instanceof Date) {
                        innerValue = row[j].toLocaleString();
                    };
                    var result = innerValue.replace(/"/g, '""');
                    if (result.search(/("|,|\n)/g) >= 0)
                        result = '"' + result + '"';
                    if (j > 0)
                        finalVal += ',';
                    finalVal += result;
                }
                return finalVal + '\n';
            };

            var csvFile = '';
            for (var i = 0; i < rows.length; i++) {
                csvFile += processRow(rows[i]);
            }

            var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
            if (navigator.msSaveBlob) { // IE 10+
                navigator.msSaveBlob(blob, filename);
            } else {
                var link = document.createElement("a");
                if (link.download !== undefined) { // feature detection
                    // Browsers that support HTML5 download attribute
                    var url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
        }
    
        
        function readSingleFile(evt) {
                //Retrieve the first (and only!) File from the FileList object
                var f = evt.target.files[0]; 

                if (f) {
                    
                  var p = f.name.indexOf("__") ;
                  if( p <0){
                      file_name = f.name.substr(0, f.name.length-4)+"__"  ;
                  }else{
                      file_name = f.name.substr(0, p)+"__"  ;
                  }
                    
                  sentences=[] ;
                  sentences_n=[] ;                  
                    
                  var r = new FileReader();
                  r.onload = function(e) { 
                            var contents = e.target.result;                            
                            //alert(contents);
                            contents = contents.split("\n") ;
                            for( var ci=0 ; ci<contents.length ; ci++){
                                
                                var tokens = contents[ci].split(",") ;
                                if( tokens != null  && tokens.length ==2 ){
                                    sentences.push(tokens[1]) ;
                                    sentences_n.push(tokens[0]) ;
                                }
                                
                            }  
                            var sort_result = sort_sentences( sentences , sentences_n) ;
                            sentences   = sort_result[0] ;                          
                            sentences_n = sort_result[1] ;
                            list_items();
                            add_timer();
                        }
                  //alert("start read!!");
                  r.readAsText(f);
                } else { 
                  alert("Failed to load file");
                }
        }
            
        
        $(document).ready(function() {            
            document.getElementById('loadfile').addEventListener('change', readSingleFile, false);        
        });        
    
    </script>
    
    
      </body>
</html>
