<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
      
      <style>
          @import url(http://fonts.googleapis.com/earlyaccess/notosanstc.css);
          body {
            font-family: 'Noto Sans TC', sans-serif;
          }
          .word{
              font-size: 6em;
          }
          .answer{
              font-family: 'Noto Sans TC', sans-serif;
              font-size: 6em;
          }
          li{
              height: 90px;
          }
            
          input{
              margin-left: 250px;
              margin-top: -25px;
              width: 500px ;
          }
      
      </style>      

    <title>聽力練習</title>
  </head>
  <body>
      
     
        <nav class="navbar fixed-top navbar-light bg-light">
            <span class="navbar-brand mb-0 h1">聽力練習</span>
            <span id='correct_count' style="color: cornflowerblue;" class="navbar-brand mb-0 h1">0</span>
            <span id='wrong_count' style="color: darkred;"  class="navbar-brand mb-0 h1">-0</span>
            <div class="dropdown">
              <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                練習項目
              </button>
              <div id='list_items' class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    
                </div>
            </div>
            <button class="btn btn-outline-danger" onclick="save_data()">儲存</button>
        </nav>
      
        
        <ul style="margin-top: 80px;" class="list-group" id='main'>
          
        </ul>
        
        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
        <script language="javascript" src="http://tts.itri.org.tw/TTScript/Text2SpeechJsApiV2.php?key=*031*3D*17*3C*21*3A3*17*3C*215*3A*2A*14*2Aekn@-_jif*21*2C*21*3D5*2C*26ekn@-_ji*27"></script> 
        <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-database.js"></script>
        <script>
            
            
            var database ;
            var basic_path= "/chung-ze/listen_merge/" ;
            var all_data={} ;   
            var task_data={} ;
            var list = [] ;
      
            $(document).ready(function(){                
                prepareFB() ;
            });
            
           
            function build_selected_items(){
                var target = document.getElementById('list_items') ;
                var html ="" ;
                for( var key in task_data.sentence.topic){
                    html += "<a class=\"dropdown-item\" onclick='switch_type(\""+key+"\" , \"sent\");'>"+key+"</a>"
                }
                target.innerHTML = html ;
            }
            
            function get_data(){
                    // 資料位置
                    var ref = database.ref(  basic_path ) ;
                    // 建立資料更新時的方法
                    ref.once( 'value' , read_data);                
                    function read_data( snapshot ){
                        all_data = snapshot.val() ;
                        console.log( all_data) ;
                    }                
                }
            
            function addCount(term){
                if( all_data == null ){
                    all_data ={} ;
                }
                if( all_data[term] == null ){
                    all_data[term] = 1 ;
                } else{
                    all_data[term] = parseInt( all_data[term]) +1 ;
                }
            }            

            
            function prepareFB(){
                
                var config = {
                apiKey: "AIzaSyBaINk2-3m_qieit3noR6KdKKm3qRAfEhI",
                authDomain: "typing-counter.firebaseapp.com",
                databaseURL: "https://typing-counter.firebaseio.com",
                projectId: "typing-counter",
                storageBucket: "typing-counter.appspot.com",
                messagingSenderId: "48164465117"
                };

                // 初始化 app
                firebase.initializeApp(config);
                // 取得資料庫物件
                database = firebase.database() ;
                var ref = database.ref('listen_task');
                ref.once( 'value' , read_data);                
                function read_data( snapshot ){
                        task_data = snapshot.val() ;
                        console.log( task_data) ;
                        build_selected_items() ;
                } 
                
            }
            
            function save_data(){
                                
                // 資料位置
                var ref = database.ref( basic_path);
                // 設置資料
                ref.set(all_data) ;                
            
                alert('OK');
            }            
            
            
            function play_tts( target , target_media ){
                var tts = new TTS(); 
                //tts.muteTag = "id:mute|class:mute"; 
                tts.PlayerSet.hidden = false;
                tts.ConvertInit("id:"+target,target_media,"Bruce","100","0","0","0","5");
            }
            
            function check(target){
                var ans    =  document.getElementById(target).textContent.trim() ;
                var input  =  document.getElementById(target.replace('c','i')).value.trim() ;
                if( ans == input ){
                    var n = parseInt( document.getElementById('correct_count').textContent)+1 ;
                    document.getElementById('correct_count').textContent = n ;
                    addCount(ans) ;
                }else{
                    var n = parseInt( document.getElementById('wrong_count').textContent)-1 ;
                    document.getElementById('wrong_count').textContent = n ;
                    document.getElementById(target.replace('c','b')).className = 'btn btn-outline-danger';
                    addCount('-'+ans) ;
                }
                document.getElementById(target.replace('c','b')).disabled=true ;
                document.getElementById(target.replace('c','b')).textContent=ans ;
            }
            
            function switch_type( topic , t_type ){
                
                if( t_type == 'basic'){                  
                    basic_path= "/chung-ze/listen_merge/" ;
                }else if(t_type == 'sent'){         
                    basic_path= "/chung-ze/listen_sent/" ;
                }
                
                
                var t = task_data.sentence.topic[topic].list;
                for(var key in t){
                    list.push(key) ;
                }
                
                var maindiv = document.getElementById( 'main') ;
                maindiv.innerHTML = '' ;                
                
                var size = 20 ;
                for( var i=0 ; i<size ; i++){
                
                    var ri = Math.floor( Math.random()*list.length) ;
                    maindiv.innerHTML+=
                        "<li class='list-group-item'><span id='c"+i+"' style='display: none;'>"+list[ri]+"</span><span id='m"+i
                        +"'></span><input id='i"+i+"' style='width:436px;font-size: 30px;' class='form-control' type='text'>"
                        +'<button id="b'+i+'" style="margin-top: -70px;margin-left: 700px;" type="button" class="btn btn-outline-info" onclick="check(\'c'+i+'\')">check</button></li>' ;                        
                }
                
                for( var i=0 ; i<size ; i++){
//                    console.log(i);
                    play_tts( 'c'+i , 'm'+i );
                }
                
                get_data() ;
            }
      
      
        </script>
      
      
  </body>
</html>